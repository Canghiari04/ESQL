DROP DATABASE IF EXISTS ESQLDB;
CREATE DATABASE IF NOT EXISTS ESQLDB;

USE ESQLDB;

CREATE TABLE Utente (
	EMAIL VARCHAR(255) PRIMARY KEY,
    PSWD VARCHAR(255),
    NOME VARCHAR(255) NOT NULL,
    COGNOME VARCHAR(255) NOT NULL,
    TELEFONO INT(10)
)ENGINE=INNODB ;

CREATE TABLE Studente (
	EMAIL_STUDENTE VARCHAR(255) PRIMARY KEY,
    ANNO_IMMATRICOLAZIONE INT(4) NOT NULL,
    CODICE VARCHAR(16) NOT NULL,
    FOREIGN KEY (EMAIL_STUDENTE) REFERENCES Utente(EMAIL) ON DELETE CASCADE
)ENGINE=INNODB ;

CREATE TABLE Docente (
	EMAIL_DOCENTE VARCHAR(255) PRIMARY KEY,
    NOME_DIPARTIMENTO VARCHAR(255) NOT NULL,
    NOME_CORSO VARCHAR(255) NOT NULL,
    FOREIGN KEY (EMAIL_DOCENTE) REFERENCES Utente(EMAIL) ON DELETE CASCADE
)ENGINE=INNODB ;

CREATE TABLE Tabella_Esercizio (
	ID INT AUTO_INCREMENT PRIMARY KEY,
    NOME VARCHAR(255) NOT NULL,
    DATA_CREAZIONE DATETIME NOT NULL,
    NUM_RIGHE INT NOT NULL,
    EMAIL_DOCENTE VARCHAR(255) NOT NULL,
    FOREIGN KEY(EMAIL_DOCENTE) REFERENCES Docente(EMAIL_DOCENTE) ON DELETE CASCADE
)ENGINE=INNODB ;

CREATE TABLE Manipolazione_Riga (
    ID INT AUTO_INCREMENT PRIMARY KEY,
    ID_TABELLA INT,
    FOREIGN KEY(ID_TABELLA) REFERENCES Tabella_Esercizio(ID) ON DELETE CASCADE
)ENGINE=INNODB;

CREATE TABLE Attributo (
	ID INT AUTO_INCREMENT PRIMARY KEY,
    ID_TABELLA INT,
    TIPO VARCHAR(255) NOT NULL,
    NOME VARCHAR(255) NOT NULL,
    CHIAVE_PRIMARIA BOOLEAN NOT NULL,
    FOREIGN KEY(ID_TABELLA) REFERENCES Tabella_Esercizio(ID) ON DELETE CASCADE 
)ENGINE=INNODB ;

CREATE TABLE Vincolo_Integrita (
	REFERENTE INT,
    REFERENZIATO INT,
    PRIMARY KEY(REFERENTE, REFERENZIATO),
    FOREIGN KEY(REFERENTE) REFERENCES Attributo(ID) ON DELETE CASCADE,
    FOREIGN KEY(REFERENZIATO) REFERENCES Attributo(ID) ON DELETE CASCADE
)ENGINE=INNODB ;

CREATE TABLE Test (
	TITOLO VARCHAR(255) PRIMARY KEY,
    EMAIL_DOCENTE VARCHAR(255) NOT NULL,
    FOTO BLOB,
    DATA_CREAZIONE DATE NOT NULL,
    VISUALIZZA_RISPOSTE BOOLEAN NOT NULL,
    FOREIGN KEY (EMAIL_DOCENTE) REFERENCES Docente(EMAIL_DOCENTE) ON DELETE CASCADE
)ENGINE=INNODB ;

CREATE TABLE Quesito (
	ID INT,
    TITOLO_TEST VARCHAR(255),
    DIFFICOLTA ENUM('BASSO', 'MEDIO', 'ALTO') NOT NULL,
    NUM_RISPOSTE INT NOT NULL,
    DESCRIZIONE VARCHAR(255) NOT NULL,
    PRIMARY KEY(ID, TITOLO_TEST),
    FOREIGN KEY(TITOLO_TEST) REFERENCES Test(TITOLO) ON DELETE CASCADE
)ENGINE=INNODB ;

CREATE TABLE Afferenza (
	ID_QUESITO INT,
    TITOLO_TEST VARCHAR(255),
    ID_TABELLA INT,
    PRIMARY KEY(ID_QUESITO, TITOLO_TEST, ID_TABELLA),
    FOREIGN KEY(ID_QUESITO, TITOLO_TEST) REFERENCES Quesito(ID, TITOLO_TEST) ON DELETE CASCADE,
    FOREIGN KEY(ID_TABELLA) REFERENCES Tabella_Esercizio(ID) ON DELETE CASCADE
)ENGINE=INNODB ;

CREATE TABLE Domanda_Chiusa (
	ID_DOMANDA_CHIUSA INT,
    TITOLO_TEST VARCHAR(255),
    PRIMARY KEY (ID_DOMANDA_CHIUSA, TITOLO_TEST),
    FOREIGN KEY(ID_DOMANDA_CHIUSA, TITOLO_TEST) REFERENCES Quesito(ID, TITOLO_TEST) ON DELETE CASCADE 
)ENGINE=INNODB ;

CREATE TABLE Opzione_Risposta (
	ID INT,
    ID_DOMANDA_CHIUSA INT,
    TITOLO_TEST VARCHAR(255),
    TESTO VARCHAR(255) NOT NULL,
    SOLUZIONE BOOLEAN NOT NULL,
    PRIMARY KEY(ID, ID_DOMANDA_CHIUSA, TITOLO_TEST),
    FOREIGN KEY(ID_DOMANDA_CHIUSA, TITOLO_TEST) REFERENCES Domanda_Chiusa(ID_DOMANDA_CHIUSA, TITOLO_TEST) ON DELETE CASCADE    
)ENGINE=INNODB ;

CREATE TABLE Domanda_Codice (
	ID_DOMANDA_CODICE INT,
    TITOLO_TEST VARCHAR(255),
    PRIMARY KEY(ID_DOMANDA_CODICE, TITOLO_TEST),
    FOREIGN KEY(ID_DOMANDA_CODICE, TITOLO_TEST) REFERENCES Quesito(ID, TITOLO_TEST) ON DELETE CASCADE    
)ENGINE=INNODB ;

CREATE TABLE Sketch_Codice (
	ID INT,
    ID_DOMANDA_CODICE INT,
    TITOLO_TEST VARCHAR(255),
    TESTO VARCHAR(255) NOT NULL,
    SOLUZIONE BOOLEAN NOT NULL,
    PRIMARY KEY(ID, ID_DOMANDA_CODICE, TITOLO_TEST),
    FOREIGN KEY(ID_DOMANDA_CODICE, TITOLO_TEST) REFERENCES Domanda_Codice(ID_DOMANDA_CODICE, TITOLO_TEST) ON DELETE CASCADE    
)ENGINE=INNODB ;

CREATE TABLE Completamento (
	TITOLO_TEST VARCHAR(255), 
    EMAIL_STUDENTE VARCHAR(255),
    STATO ENUM('APERTO', 'INCOMPLETAMENTO', 'CONCLUSO') NOT NULL, 
    DATA_ULTIMARISPOSTA DATETIME,
    DATA_PRIMARISPOSTA DATETIME,
    PRIMARY KEY(TITOLO_TEST, EMAIL_STUDENTE),
    FOREIGN KEY(TITOLO_TEST) REFERENCES Test(TITOLO) ON DELETE CASCADE,
    FOREIGN KEY(EMAIL_STUDENTE) REFERENCES Studente(EMAIL_STUDENTE) ON DELETE CASCADE
)ENGINE=INNODB ;

CREATE TABLE Risposta (
	EMAIL_STUDENTE VARCHAR(255),
    ID_QUESITO INT,
    TITOLO_TEST VARCHAR(255),
    TESTO VARCHAR(255) NOT NULL,
    ESITO BOOLEAN NOT NULL,
    PRIMARY KEY(EMAIL_STUDENTE, ID_QUESITO, TITOLO_TEST),
    FOREIGN KEY(EMAIL_STUDENTE) REFERENCES Studente(EMAIL_STUDENTE) ON DELETE CASCADE,
    FOREIGN KEY(ID_QUESITO, TITOLO_TEST) REFERENCES Quesito(ID, TITOLO_TEST) ON DELETE CASCADE
)ENGINE=INNODB ;

CREATE TABLE Messaggio (
	ID INT AUTO_INCREMENT PRIMARY KEY,
    EMAIL_DOCENTE VARCHAR(255) NOT NULL,
    TESTO VARCHAR(255) NOT NULL,
    TITOLO VARCHAR(255) NOT NULL,
    TITOLO_TEST VARCHAR(255) NOT NULL,
    DATA_INSERIMENTO DATE NOT NULL,
    FOREIGN KEY(TITOLO_TEST) REFERENCES Test(TITOLO) ON DELETE CASCADE,
    FOREIGN KEY(EMAIL_DOCENTE) REFERENCES Docente(EMAIL_DOCENTE) ON DELETE CASCADE
)ENGINE=INNODB ;

CREATE TABLE Messaggio_Studente (
	ID_MESSAGGIO_STUDENTE INT PRIMARY KEY,
    EMAIL_STUDENTE VARCHAR(255) NOT NULL,
    FOREIGN KEY(ID_MESSAGGIO_STUDENTE) REFERENCES Messaggio(ID) ON DELETE CASCADE,
    FOREIGN KEY(EMAIL_STUDENTE) REFERENCES Studente(EMAIL_STUDENTE) ON DELETE CASCADE
)ENGINE=INNODB ;